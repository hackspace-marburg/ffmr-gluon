From: Oleander Reis <oleander@oleander.cc>
Date: Fri, 6 Oct 2017 23:57:57 +0200
Subject: ar71xx-generic: Fix flash layout and MAC addresses of Meraki MR12/MR16

Fixes #993. Only verified for MR16.

---
 target/linux/ar71xx/files/arch/mips/ath79/mach-mr12.c | 16 +++++++++++-----
 target/linux/ar71xx/files/arch/mips/ath79/mach-mr16.c | 19 ++++++++++++-------
 target/linux/ar71xx/image/generic.mk                  |  4 ++--
 3 files changed, 25 insertions(+), 14 deletions(-)

diff --git a/target/linux/ar71xx/files/arch/mips/ath79/mach-mr12.c b/target/linux/ar71xx/files/arch/mips/ath79/mach-mr12.c
index 5a337e5c9f..fc547f8d7e 100644
--- a/target/linux/ar71xx/files/arch/mips/ath79/mach-mr12.c
+++ b/target/linux/ar71xx/files/arch/mips/ath79/mach-mr12.c
@@ -42,7 +42,9 @@
 
 #define MR12_WAN_PHYMASK    BIT(4)
 
-#define MR12_CALDATA0_OFFSET            0x21000
+#define MR12_MAC			0xbf090000
+#define MR12_ART			0xbfff0000
+#define MR12_CALDATA0_OFFSET		0x1000
 
 static struct gpio_led MR12_leds_gpio[] __initdata = {
 	{
@@ -89,8 +91,10 @@ static struct gpio_keys_button MR12_gpio_keys[] __initdata = {
 
 static void __init MR12_setup(void)
 {
-	u8 *mac = (u8 *) KSEG1ADDR(0xbffd0000);
-	u8 wlan_mac[ETH_ALEN];
+	u8 *mac = (u8 *) KSEG1ADDR(MR12_MAC);
+	u8 *art = (u8 *) KSEG1ADDR(MR12_ART);
+
+	u8 wlan0_mac[ETH_ALEN];
 
 	ath79_register_mdio(0,0x0);
 
@@ -99,6 +103,8 @@ static void __init MR12_setup(void)
 	ath79_eth0_data.phy_mask = MR12_WAN_PHYMASK;
 	ath79_register_eth(0);
 
+	ath79_init_mac(wlan0_mac, mac, 1);
+
 	ath79_register_m25p80(NULL);
 
 	ath79_register_leds_gpio(-1, ARRAY_SIZE(MR12_leds_gpio),
@@ -107,8 +113,8 @@ static void __init MR12_setup(void)
 					ARRAY_SIZE(MR12_gpio_keys),
 					MR12_gpio_keys);
 
-	ath79_init_mac(wlan_mac, mac, 1);
-	ap91_pci_init(mac + MR12_CALDATA0_OFFSET, wlan_mac);
+	ap91_pci_init(art + MR12_CALDATA0_OFFSET, wlan0_mac);
+
 }
 
 MIPS_MACHINE(ATH79_MACH_MR12, "MR12", "Meraki MR12", MR12_setup);
diff --git a/target/linux/ar71xx/files/arch/mips/ath79/mach-mr16.c b/target/linux/ar71xx/files/arch/mips/ath79/mach-mr16.c
index 9da21eab5a..0cf61f92eb 100644
--- a/target/linux/ar71xx/files/arch/mips/ath79/mach-mr16.c
+++ b/target/linux/ar71xx/files/arch/mips/ath79/mach-mr16.c
@@ -42,8 +42,10 @@
 
 #define MR16_WAN_PHYMASK    BIT(0)
 
-#define MR16_CALDATA0_OFFSET		0x21000
-#define MR16_CALDATA1_OFFSET		0x25000
+#define MR16_MAC			0xbf080066
+#define MR16_ART			0xbfff0000
+#define MR16_CALDATA0_OFFSET		0x1000
+#define MR16_CALDATA1_OFFSET		0x5000
 
 static struct gpio_led MR16_leds_gpio[] __initdata = {
 	{
@@ -90,7 +92,9 @@ static struct gpio_keys_button MR16_gpio_keys[] __initdata = {
 
 static void __init MR16_setup(void)
 {
-	u8 *mac = (u8 *) KSEG1ADDR(0xbffd0000);
+	u8 *mac = (u8 *) KSEG1ADDR(MR16_MAC);
+	u8 *art = (u8 *) KSEG1ADDR(MR16_ART);
+
 	u8 wlan0_mac[ETH_ALEN];
 	u8 wlan1_mac[ETH_ALEN];
 
@@ -101,6 +105,9 @@ static void __init MR16_setup(void)
 	ath79_eth0_data.phy_mask = MR16_WAN_PHYMASK;
 	ath79_register_eth(0);
 
+	ath79_init_mac(wlan0_mac, mac, 1);
+	ath79_init_mac(wlan1_mac, mac, 2);
+
 	ath79_register_m25p80(NULL);
 
 	ath79_register_leds_gpio(-1, ARRAY_SIZE(MR16_leds_gpio),
@@ -109,10 +116,8 @@ static void __init MR16_setup(void)
 					ARRAY_SIZE(MR16_gpio_keys),
 					MR16_gpio_keys);
 
-	ath79_init_mac(wlan0_mac, mac, 1);
-	ath79_init_mac(wlan1_mac, mac, 2);
-	ap94_pci_init(mac + MR16_CALDATA0_OFFSET, wlan0_mac,
-		    mac + MR16_CALDATA1_OFFSET, wlan1_mac);
+	ap94_pci_init(art + MR16_CALDATA0_OFFSET, wlan0_mac,
+					art + MR16_CALDATA1_OFFSET, wlan1_mac);
 }
 
 MIPS_MACHINE(ATH79_MACH_MR16, "MR16", "Meraki MR16", MR16_setup);
diff --git a/target/linux/ar71xx/image/generic.mk b/target/linux/ar71xx/image/generic.mk
index e11a8992f9..df4c3bec27 100644
--- a/target/linux/ar71xx/image/generic.mk
+++ b/target/linux/ar71xx/image/generic.mk
@@ -185,11 +185,11 @@ define Device/mr12
   DEVICE_TITLE := Meraki MR12
   DEVICE_PACKAGES := kmod-spi-gpio
   BOARDNAME = MR12
-  IMAGE_SIZE = 15680k
-  MTDPARTS = spi0.0:256k(u-boot)ro,256k(u-boot-env)ro,13440k(rootfs),2240k(kernel),64k(mac),128k(art)ro,15680k@0x80000(firmware)
+  IMAGE_SIZE = 15616k
+  MTDPARTS = spi0.0:256k(u-boot)ro,256k(u-boot-env)ro,128k(config)ro,13312k(rootfs),2304k(kernel),128k(art)ro,15616k@0xa0000(firmware)
   IMAGE/kernel.bin = append-kernel
   IMAGE/rootfs.bin = append-rootfs | pad-rootfs
-  IMAGE/sysupgrade.bin = append-rootfs | pad-rootfs | pad-to 13440k | append-kernel | check-size $$$$(IMAGE_SIZE)
+  IMAGE/sysupgrade.bin = append-rootfs | pad-rootfs | pad-to 13312k | append-kernel | check-size $$$$(IMAGE_SIZE)
   IMAGES := kernel.bin rootfs.bin sysupgrade.bin
 endef
 TARGET_DEVICES += mr12
@@ -198,11 +198,11 @@ define Device/mr16
   DEVICE_TITLE := Meraki MR16
   DEVICE_PACKAGES := kmod-spi-gpio
   BOARDNAME = MR16
-  IMAGE_SIZE = 15680k
-  MTDPARTS = spi0.0:256k(u-boot)ro,256k(u-boot-env)ro,13440k(rootfs),2240k(kernel),64k(mac),128k(art)ro,15680k@0x80000(firmware)
+  IMAGE_SIZE = 15616k
+  MTDPARTS = spi0.0:256k(u-boot)ro,256k(u-boot-env)ro,128k(config)ro,13312k(rootfs),2304k(kernel),128k(art)ro,15616k@0xa0000(firmware)
   IMAGE/kernel.bin = append-kernel
   IMAGE/rootfs.bin = append-rootfs | pad-rootfs
-  IMAGE/sysupgrade.bin = append-rootfs | pad-rootfs | pad-to 13440k | append-kernel | check-size $$$$(IMAGE_SIZE)
+  IMAGE/sysupgrade.bin = append-rootfs | pad-rootfs | pad-to 13312k | append-kernel | check-size $$$$(IMAGE_SIZE)
   IMAGES := kernel.bin rootfs.bin sysupgrade.bin
 endef
 TARGET_DEVICES += mr16
-- 
2.14.2

